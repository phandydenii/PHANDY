
<div class="modal fade " data-backdrop="static" data-keyboard="false" id="RoomDetailModal" tabindex="-1" role="dialog" aria-labelledby="RoomDetailModal" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div id="divLoadingModal"></div>
        <div class="modal-content">
            <div class="modal-header clearfix">
                <button type="button" id="btnCloseRoomDetail" class="btn btn-danger btn-xs pull-right" data-dismiss="modal" onclick="OnCloseRoomDetail()"><span class="glyphicon glyphicon-remove"></span></button>
                <h4 class="modal-title text-center" style="color: darkblue;"><b>@Resources.Content.RoomDetail</b></h4>               
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-12">
                        <div​​ id="alertmsm" class="alert alert-danger" style="display:none">
                            <strong id="BlockNote"></strong>
                        </div​​>
                    </div>
                </div>
                <div class="row">
                    <input id="RoomDetailid" name="RoomDetailid" type="text" style="display: none;" disabled="disabled" value="" class="form-control" />
                    <input id="roomid" name="roomid" type="text" style="display: none;" disabled="disabled" value="" class="form-control" />
                    <input id="guestid" name="guestid" type="text" style="display: none;" disabled="disabled" value="" class="form-control" />
                    <input id="bookingid" name="bookingid" type="text" style="display: none;" disabled="disabled" value="" class="form-control" />
                    <input id="checkinid" name="checkinid" type="text" style="display: none;" disabled="disabled" value="" class="form-control" />

                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-2">
                                        <h5><b>@Resources.Content.Room</b></h5>
                                    </div>
                                    <div class="col-md-8">
                                        <hr />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="list-group" id="listroom">
                                            <li class="list-group-item">
                                                <span class="badge" id="rmno"></span>
                                                @Resources.Content.RoomNo
                                            </li>
                                            <li class="list-group-item">
                                                <span class="badge" id="roomtype"></span>
                                                @Resources.Content.RoomType
                                            </li>
                                            <li class="list-group-item">
                                                <span class="badge" id="flno"></span>
                                                @Resources.Content.Floor
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-group">
                                            <li class="list-group-item">
                                                <span class="badge" id="status"></span>
                                                @Resources.Content.Status
                                            </li>
                                            <li class="list-group-item">
                                                <span class="badge" id="roomprice"></span>
                                                @Resources.Content.RoomPrice
                                            </li>
                                            <li class="list-group-item">
                                                <span class="badge" id="rmky"></span>
                                                @Resources.Content.RoomKey
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-2">
                                        <h5><b>@Resources.Content.Item</b></h5>
                                    </div>
                                    <div class="col-md-8">
                                        <hr />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <ul id="itlist" class="list-group"></ul>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-2">
                                        <h5><b>@Resources.Content.Guest</b></h5>
                                    </div>
                                    <div class="col-md-8">
                                        <hr />
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <ul class="list-group" id="guestlist">
                                            @*code in index*@
                                        </ul>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="modal-footer">
                    <button type="button" id="btnCancel" onclick="OnCnacel()" class="btn btn-danger btn-sm pull-right" style="margin-left:10px;width:100px" value=""><span class="glyphicon glyphicon-remove"></span> @Resources.Content.Close</button>
                    <button type="button" id="btnBlock" onclick="OnBlockAction('@User.IsInRole("Block Room")' ? true:false)" class="btn btn-default btn-sm pull-right" style="margin-left:10px;width:100px"><span class="glyphicon glyphicon-ban-circle"></span> @Resources.Content.Block</button>
                    <button type="button" id="btnUnBlock" onclick="OnUnBlockAction('@User.IsInRole("Block Room")' ? true:false)" class="btn btn-info btn-sm pull-right" style="margin-left:10px;width:100px"><span class="glyphicon glyphicon-ban-circle"></span> @Resources.Content.UnBlock</button>
                    <button type="button" id="btnCheckOut" onclick="OnCheckOutAction('@User.IsInRole("Manage CheckOut")' ? true:false)" class="btn btn-warning btn-sm pull-right" style="margin-left:10px;width:100px"><span class="glyphicon glyphicon-log-out"></span> @Resources.Content.CheckOut</button>
                    <button type="button" id="btnCancelBooking" onclick="OnCancelBooking('@User.IsInRole("Cancel Booking")' ? true:false)" class="btn btn-warning btn-sm pull-right" style="margin-left:10px;width:100px"><span class="glyphicon glyphicon-minus-sign"></span> @Resources.Content.CancelBooking</button>
                    <button type="button" id="btnCheckIn" onclick="OnCheckInAction('@User.IsInRole("Manage Check In")' ? true:false)" class="btn btn-primary btn-sm pull-right" style="margin-left:10px;width:100px"><span class="glyphicon glyphicon-log-in"></span> @Resources.Content.CheckIn</button>
                    <button type="button" id="btnBook" onclick="OnBookAction('@User.IsInRole("Manage Booking")' ? true:false)" class="btn btn-success  btn-sm pull-right" style="margin-left:10px;width:100px"><span class="glyphicon glyphicon-usd"></span> @Resources.Content.Book</button>
                    @*<button type="button" id="btnCheckInNow" onclick="OnCheckInNowAction('@User.IsInRole("Manage Check In")' ? true:false)" class="btn btn-primary  btn-sm pull-right" style="margin-left:10px;width:100px">@Resources.Content.CheckIn</button>*@
                             
            </div>
        </div>
    </div>  
</div>

@Html.Partial("_Book")
@Html.Partial("_Block")
@Html.Partial("_CheckIn")
@Html.Partial("_CheckInNow")
@Html.Partial("_Payment")
@Html.Partial("_CheckOut")
<script>
    function OnCloseRoomDetail() {
        window.location.reload(true);
    }
    function OnCnacel() {
        window.location.reload(true);
    }

    //On Book
    function OnBookAction(role) {
        if (role == false) {
            toastr.options = {"progressBar": true };
            toastr.warning("Your don't have permission!", "Service Response");
            return false;
        }

        var rmid = document.getElementById('roomid').value;
        $("#RoomDetailModal").modal('hide');
        $("#BookModal").modal('show');

        $.ajax({
            url: "/api/rooms/" + rmid,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            datatype: "json",
            success: function (result) {
                //$('#lblbookrmid').text("Book Room "+result.room_no);
                $("#frmbookroomid").val(rmid);
                $("#bookroomid").val(rmid);
                //$("#totalbooking").val(result.price);
               // $("#paydollarbooking").val(result.price / 2);
                $("#roompriceb").val(result.price);
            },
            error: function (errormessage) {
                toastr.error("No Record Select!", "Service Response");
            }
        });

        ///Get booking invoice
        $.get("/api/bookinginvoiceno", function (data) {
            $('#bookingno').val(data);
        });

        $.get("/api/ExchangeRates/1/2", function (data) {
            $("#exchagerate").text(data.rate+" រៀល");
        });

        document.getElementById('frmbookroomid').disabled = true;
        document.getElementById('bookingno').disabled = true;
        $("#lblidroom").text(rmid);
    }
    
    //On Check In
    function OnCheckInAction(role) {
        $.get("/api/ExchangeRates/1/2", function (data) {
            $("#exrate").val(data.rate);
        });

        if (role == false) {
            toastr.options = { "progressBar": true };
            toastr.warning("Your don't have permission!", "Service Response");
            return false;
        }

        var bid = document.getElementById('bookingid');
        $("#bookid").val(bid.value);
        var rmid = document.getElementById('roomid');
        var guestid = document.getElementById('guestid');
        $("#CheckInModal").modal("show");
        $("#chroomid").val(rmid.value);
        $("#guestidchin").val(guestid.value);
        $.get("/api/rooms/" + rmid.value, function (data) {
            $("#roompricech").val(data.price);
            $("#payforroom").val(data.price);
            $("#prepaid").val(data.price / 2);
            $("#paydollar").val(data.price + (data.price / 2));
        });
    }

    //On Check Out
    function OnCheckOutAction(role) {
        if (role == false) {
            toastr.options = { "progressBar": true };
            toastr.warning("Your don't have permission!", "Service Response");
            return false;
        }

        $("#RoomDetailModal").modal("hide");
        $("#CheckOutModal").modal("show");
        $.ajax({
            url: "/api/checkin_v/" + $("#checkinid").val(),
            type: "GET",
            contentType: "application/json;charset=utf-8",
            datatype: "json",
            success: function (result) {
                $("#chinid").val(result[0].id);
                $("#gid").val(result[0].guestid);
                $("#rmid").val(result[0].roomid);
                var stdate = moment(result[0].enddate).format("YYYY-MM-DD");

                const EndDate = new Date();
                const StartDate = new Date(result[0].enddate);
                const oneDay = 1000 * 60 * 60 * 24;
                const start = Date.UTC(EndDate.getFullYear(), EndDate.getMonth(), EndDate.getDate());
                const end = Date.UTC(StartDate.getFullYear(), StartDate.getMonth(), StartDate.getDate());
                var countday = (start - end) / oneDay;

                var totalday = countday;
                if (countday >= 30) {
                    totalday = 30;
                }

                $("#startdatechout").val(stdate);
                $("#wstart").val(result[0].wendrecord);
                $("#estart").val(result[0].eendrecord);                   
                $("#rmprice").val(result[0].price);
                $("#svprice").val(result[0].servicecharge);
                $("#paybefor").val(result[0].price + result[0].prepaid);
                $("#totalroomprice").val((result[0].price / 30 * parseInt(totalday)).toFixed(2));

            },
            error: function (errormessage) {
                toastr.error("No Record Select!", "Service Response");
            }
        });
        $.get("/api/WEPrice/1/2", function (data) {
            $("#wpid").val(data.id);
            $("#wprice").val(data.waterprice);
            $("#pprice").val(data.electricprice);
        });
        $.get("/api/ExchangeRates/1/2", function (data) {
            $("#exrate").val(data.rate);
            $("#lblExchangeRate").text("1 $ = "+data.rate+" រៀល");
        });
    }

    //Cancel Booking
    function OnCancelBooking(role) {
        if (role == false) {
            toastr.options = { "progressBar": true };
            toastr.warning("Your don't have permission!", "Service Response");
            return false;
        }
        bootbox.confirm({
            message: "Are you sure want to cancel booking this room?",
            button: {
                cancel: {
                    label: "Cancel",
                    ClassName: "btn-default",
                },
                confirm: {
                    label: "Delete",
                    ClassName: "btn-danger"
                }
            },
            callback: function (result) {
                if (result) {
                    $.ajax({
                        type: "PUT",
                        url: "/api/bookingstatus/" + $("#bookingid").val() + "/Cancel",
                        contentType: false,
                        processData: false,
                        // data: status,
                        success: function (result) {
                            toastr.success("Booking has been cancel successfully.", "Server Response");
                            $("#RoomDetailModal").modal("hide");
                        },
                        error: function (error) {
                            toastr.error("Unblock room fail!", "Server Response");
                        }
                    });

                    $.ajax({
                        type: "PUT",
                        url: "/api/updateroomstatus/" + $("#roomid").val() + "/FREE",
                        contentType: false,
                        processData: false,
                        // data: status,
                        success: function (result) {
                            toastr.success("Room has been unblock successfully.", "Server Response");
                            window.location.reload(true);
                        },
                        error: function (error) {
                            toastr.error("Unblock room fail!", "Server Response");
                        }
                    });

                    window.location.reload(true);
                }
            }
        });
    }

    //UnBlock Room
    function OnUnBlockAction(role) {
        if (role == false) {
            toastr.options = { "progressBar": true };
            toastr.warning("Your don't have permission!", "Service Response");
            return false;
        }
        bootbox.confirm({
            message: "Are you sure want to UnBlock this room?",
            button: {
                cancel: {
                    label: "Cancel",
                    ClassName: "btn-default",
                },
                confirm: {
                    label: "Delete",
                    ClassName: "btn-danger"
                }
            },
            callback: function (result) {
                if (result) {
                    $.ajax({
                        url: "/api/rooms/" + $("#roomid").val(),
                        type: "GET",
                        contentType: "application/json;charset=utf-8",
                        datatype: "json",
                        success: function (result) {
                            var data = new FormData();
                            data.append("note", result.note + ' Open date ');
                            data.append("status", 'FREE');
                            $.ajax({
                                type: "PUT",
                                url: "/api/blockroom/" + $("#roomid").val(),
                                contentType: false,
                                processData: false,
                                data: data,
                                success: function (result) {
                                    toastr.success("Room has been UnBlock successfully.", "Server Response");
                                    window.location.reload(true);
                                },
                                error: function (error) {
                                    toastr.error("Block room fail!", "Server Response");
                                }
                            });
                        },
                        error: function (error) {
                            toastr.error("Block room fail!", "Server Response");
                        }
                    });
                }
            }
        });
    }
    //On Block Room
    function OnBlockAction(role) {
        if (role == false) {
            toastr.options = { "progressBar": true };
            toastr.warning("Your don't have permission!", "Service Response");
            return false;
        }

        var rmid = document.getElementById('roomid').value;
        $("#roomid").val(rmid);
        $("#BlockRoomModal").modal('show');
    }

    function OnCheckInNowAction(role) {
        if (role == false) {
            toastr.options = { "progressBar": true };
            toastr.warning("Your don't have permission!", "Service Response");
            return false;
        }

        var rmid = document.getElementById('roomid').value;
        $("#chnowroomid").val(rmid);
        $("#CheckInNowModal").modal('show');
        $.ajax({
            url: "/api/rooms/" + rmid,
            type: "GET",
            contentType: "application/json;charset=utf-8",
            datatype: "json",
            success: function (result) {
                $("#roomprices").val(result.price);
                $("#payforrooms").val(result.price);
            },
            error: function (errormessage) {
                toastr.error("No Record Select!", "Service Response");
            }
        });
    }
</script>


