<div class="modal fade " data-backdrop="static" data-keyboard="false" id="CheckInNowModal" tabindex="-1" role="dialog" aria-labelledby="CheckInNowModal" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div id="divLoadingModal"></div>
        <div class="modal-content">
            <div class="modal-header clearfix">
                <button type="button"  class="btn btn-danger btn-xs pull-right" data-dismiss="modal">បិទ</button>
                <b class="modal-title" style="color: darkblue;">ចូលស្នាក់នៅ</b>
            </div>
            <div class="modal-body">
                <div class="row">
                    <input id="checkindid" name="checkindid" type="text" style="display: none;" disabled="disabled" value="" class="form-control" />
                    <input id="roomidchin" name="roomidchin" type="text" style="display: none;" value="" class="form-control" />
                    <input id="guestid" name="guestid" type="text" style="display: none;" value="" class="form-control" />
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="guestname">ឈ្មោះភ្ញៀវ</label>
                                            <input id="guestname" name="guestname" placeholder="Enter Guest Name" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="gnamekh">ឈ្មោះភ្ញៀវជាភាសាខ្មែរ</label>
                                            <input id="gnamekh" name="gnamekh" placeholder="Enter Guest Name Khmer" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="gsex">ភេទ</label>
                                            <select class="form-control input-sm" id="gsex">
                                                <option>Male</option>
                                                <option>Female</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="dob">ថ្ងៃខែឆ្នាំកំណើត</label>
                                            <input id="dob" name="dob" type="date" value="@DateTime.Now.ToString("yyyy'-'MM'-'dd")" class="form-control input-sm" placeholder="Choose Datetime" />
                                        </div>
                                        <div class="form-group">
                                            <label for="address">អាស័យដ្ឋាន</label>
                                            <input id="address" name="address" placeholder="Enter Address" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="nationality">សញ្ជាតិ</label>
                                            <input id="nationality" name="nationality" placeholder="Enter Nationality" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="phonenumber">លេខទូរសព្ទ</label>
                                            <input id="phonenumber" name="phonenumber" placeholder="Enter Phone" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="email">អ៊ីម៉ែល</label>
                                            <input id="email" name="email" placeholder="Enter Email" type="email" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="ssn">លេខអត្តសញ្ញាណប័ណ្ណ</label>
                                            <input id="ssn" name="ssn" placeholder="Enter Social Security Number" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="passport">លិខិតឆ្លងដែន</label>
                                            <input id="passport" name="passport" placeholder="Enter Passport Number" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="bookingno">លេខរៀងកក់</label>
                                            <input id="bookingno" name="bookingno" placeholder="Enter Book No" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="frmbookroomid">លេខបន្ទប់</label>
                                            <select class="form-control input-sm" id="frmbookroomid">
                                                @foreach (var room in Model.ListRoomFree)
                                                {
                                                    <option value=@room.id>@room.room_no</option>
                                                }
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="man">បុរស</label>
                                            <input id="man" name="man" placeholder="Enter number of man" type="number" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="women">ស្ត្រី</label>
                                            <input id="women" name="women" placeholder="Enter number of women" type="number" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="child">ក្មេងៗ</label>
                                            <input id="child" name="child" placeholder="Enter number of child" type="number" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="control-label">លេខកុងទ័រភ្លើង</label>
                                            <input id="powerprerecord" name="powerprerecord" placeholder="Enter current number" value="0" type="text" class="form-control input-sm">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">លេខកុងទ័រទឹក</label>
                                            <input id="waterprerecord" name="waterprerecord" placeholder="Enter current number" value="0" type="text" class="form-control input-sm">
                                        </div>
                                        <div class="form-group">
                                            <span>អត្រាប្តូរប្រាក់</span> : 1 <span>$</span> = <label id="examount"></label><span> រៀល</span>
                                            <input type="hidden" id="exid" />

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">

                <div class="col-md-3 col-md-offset-6" id="hidecheckout">
                    <button type="button" id="btnCheckOut" data-dismiss="modal" class="btn btn-danger btn-block btn-sm">Cancel</button>
                </div>
                <div class="col-md-3" id="hidepayment">
                    <button type="button" id="btnSaveCheckIn" onclick="OnSaveCheckIn()" class="btn btn-info btn-block btn-sm">Save</button>
                </div>
            </div>
        </div>

    </div>
</div>

<script>
    function OnSaveCheckIn() {

    }

    function CreateGuest() {
        var data = new FormData();
        data.append("name", $("#guestname").val());
        data.append("namekh", $("#gnamekh").val());
        data.append("sex", $("#gsex").val());
        data.append("dob", $("#dob").val());
        data.append("address", $("#address").val());
        data.append("nationality", $("#nationality").val());
        data.append("phone", $("#phonenumber").val());
        data.append("email", $("#email").val());
        data.append("ssn", $("#ssn").val());
        data.append("passport", $("#passport").val());
        data.append("status", 'BOOK');
        $.ajax({
            type: "POST",
            url: "/api/guests",
            contentType: false,
            processData: false,
            data: data,
            success: function (result) {
                CheckInAction(result);
                $("#BookModal").modal('hide');
                window.location.reload(true);
                toastr.success("Book successfully!", "Server Respond");
            },
            error: function (error) {
                //console.log(error);
                toastr.error("Please check all selected field!.", "Server Response");
            }
        });

    }

    function CheckInAction(gid) {
        var data = {
            roomid: $('#checkinroomid').val(),
            guestid: gid,
            child: $('#child').val(),
            man: $('#man').val(),
            women: $('#women').val(),
        };
        $.ajax({
            url: "/api/checkins",
            data: JSON.stringify(data),
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {
                $("#CheckInModal").modal("hide");
                UpdateRoomStatus();

                InsertPowerUsage(result);

                InsertWaterUsage(result);

                CreateInvoice();

                toastr.success("Check In successfully.", "Server Response");
            },
            error: function (errormesage) {
                toastr.error("This Name Guest is exist in Database", "Server Respond");
                return false;
            }

        });
    }

    function UpdateRoomStatusBook() {
        $.ajax({
            type: "PUT",
            url: "/api/updateroomstatus/" + $("#roomidchin").val() + "/CHECK-IN",
            contentType: false,
            processData: false,
            // data: status,
            success: function (result) {
                //toastr.success("Room Status has been Update successfully.", "Server Response");
            },
            error: function (error) {
                toastr.error("Update room status fail!", "Server Response");
            }
        });
    }


    function InsertPowerUsage(result) {
        var data = {
            guestid: $('#guestidchin').val(),
            prerecord: $('#powerprerecord').val(),
            checkinid: result,
            price: @Model.WaterPowerPriceID,
        };
        $.ajax({
            url: "/api/powerusage",
            data: JSON.stringify(data),
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {
                //window.location.reload(true);
            },
            error: function (errormesage) {
                toastr.error("Power usage insert faild!", "Server Respond");
                return false;
            }

        });
    }

    function InsertWaterUsage(result) {
        var data = {
            guestid: $('#guestidchin').val(),
            prerecord: $('#waterprerecord').val(),
            checkinid: result,
            price: @Model.WaterPowerPriceID,
        };
        $.ajax({
            url: "/api/waterusage",
            data: JSON.stringify(data),
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {
                //window.location.reload(true);
            },
            error: function (errormesage) {
                toastr.error("Water usage insert faild!", "Server Respond");
                return false;
            }

        });
    }


    function UpdateRoomStatus() {
        $.ajax({
            type: "PUT",
            url: "/api/updateroomstatus/" + $("#roomid").val() + "/CHECK-IN",
            contentType: false,
            processData: false,
            // data: status,
            success: function (result) {
                $("#RoomDetailModal").modal("hide");
                window.location.reload(true);
            },
            error: function (error) {
                toastr.error("Update room status fail!", "Server Response");
            }
        });
    }

    function UpdateGuestStatus() {
        $.ajax({
            type: "PUT",
            url: "/api/updategueststatus/" + $("#guestidchin").val() + "/CHECK-IN",
            contentType: false,
            processData: false,
            // data: status,
            success: function (result) {
                //toastr.success("Room status update successfully.", "Server Response");
                $("#RoomDetailModal").modal("hide");
                window.location.reload(true);
            },
            error: function (error) {
                toastr.error("Update room status fail!", "Server Response");
            }
        });
    }

    function CreateInvoice(gid) {
        var data = {
            invoiceno: $('#invno').val(),
            guestid: gid,
            exchangerateid: @Model.ExchangeRateID,
        };

        $.ajax({
            url: "/api/invoices",
            data: JSON.stringify(data),
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {
                //alert('Print Invoice successfully!');
            },
            error: function (errormesage) {
                toastr.error("This Booking ID is exist in Database", "Server Respond");
            }
        });
    }
</script>