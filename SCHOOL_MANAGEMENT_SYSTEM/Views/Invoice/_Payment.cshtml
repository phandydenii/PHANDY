
<div class="modal fade " data-backdrop="static" data-keyboard="false" id="PaymentModal" tabindex="-1" role="dialog" aria-labelledby="PaymentModal" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div id="divLoadingModal"></div>
        <div class="modal-content">
            <div class="modal-header clearfix">
                <button type="button" onclick="OnClosePayment()" class="btn btn-danger btn-xs pull-right" data-dismiss="modal">បិទ</button>
                <b class="modal-title" style="color: darkblue;">បង់ប្រាក់</b>
                <span style="color: darkblue;"> 1​$ = <b class="modal-title"  id="lblidroom"></b> រៀល</span>   
            </div>
            <div class="modal-body">
                <div class="row">
                    <input id="id" name="id" type="text" style="display: none;" disabled="disabled" value="" class="form-control" />
                    <input id="chinid" name="chinid" type="text" style="display: none;" value="" class="form-control" />
                    <input id="guestid" name="guestid" type="text" style="display: none;" value="" class="form-control" />
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="invoiceno">លេខវិក័យបត្រ</label>
                                            <input id="invoiceno" readonly="readonly" name="invoiceno" placeholder="Enter Guest Name" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="guestname">ភ្ញៀវ</label>
                                            <input id="guestname" name="guestname" readonly="readonly" placeholder="Enter Guest Name Khmer" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="room">បន្ទប់</label>
                                            <input id="room" name="room" readonly="readonly" placeholder="Enter Guest Name Khmer" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="roomprice">តម្លៃបន្ទប់</label>
                                            <input id="roomprice" name="roomprice" readonly="readonly" placeholder="Enter Address" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="oldwaterrecord">គីឡូទឺកចាស់</label>
                                                    <input id="oldwaterrecord" name="oldwaterrecord" readonly="readonly" placeholder="Enter Phone" type="text" value="" class="form-control input-sm" style="min-width: 100%;text-align:center" />
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="newwaterrecord">គីឡូទឺកថ្មី</label>
                                                    <input id="newwaterrecord" name="newwaterrecord" onchange="NewWaterRecordChange();" placeholder="Enter Phone" type="text" value="0" class="form-control input-sm" style="min-width: 100%;text-align:center" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="totalwater">សរុបការប្រើប្រាស់ទឺក</label>
                                            <input id="totalwater" name="totalwater" readonly="readonly" placeholder="Enter Phone" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="oldpowerrecord">គីឡូភ្លើងចាស់</label>
                                                    <input id="oldpowerrecord" name="oldpowerrecord" readonly="readonly" placeholder="Enter Phone" type="text" value="" class="form-control input-sm" style="min-width: 100%;text-align:center" />
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-group">
                                                    <label for="newpowerrecord">គីឡូភ្លើងថ្មី</label>
                                                    <input id="newpowerrecord" onchange="NewPowerRecordChange();" name="newpowerrecord"  placeholder="Enter Phone" type="text" value="0" class="form-control input-sm" style="min-width: 100%;text-align:center" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="totalpower">សរុបការប្រើប្រាស់ភ្លើង</label>
                                            <input id="totalpower" name="totalpower" readonly="readonly" placeholder="Enter Phone" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="servicecharge">ថ្លៃសេវ៉ា</label>
                                            <input id="servicecharge" name="servicecharge" readonly="readonly" placeholder="Enter Phone" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="totalpay">សរុបប្រាក់ត្រូវបង់</label>
                                            <input id="totalpay" name="totalpay" readonly="readonly" placeholder="Enter Passport Number" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="totalpaykh">ជាប្រាក់រៀល</label>
                                            <input id="totalpaykh" name="totalpaykh" readonly="readonly" placeholder="Enter Email" type="email" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="note">ចំណាំ</label>
                                            <input id="note" name="note" placeholder="Enter Social Security Number" type="text" value="" class="form-control input-sm" style="min-width: 100%" />
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-12">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="paydollar">សាច់ប្រាក់ទទួលបានជាដុល្លា</label>
                                            <input id="paydollar" name="paydollar" placeholder="$0.00" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="payriel">សាច់ប្រាក់ទទួលបានជារៀល</label>
                                            <input id="payriel" name="payriel" placeholder="$0.00" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="owe">ជំពាក់</label>
                                            <input id="owe" name="owe" placeholder="$0.00" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="returnmoney">ប្រាក់ត្រូវសងវិញ</label>
                                            <input id="returnmoney" name="returnmoney" placeholder="$0.00" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="payreilbooking">សាច់ប្រាក់</label>
                                            <input id="payreilbooking" name="payreilbooking" placeholder="000.0" type="text" value="0" class="form-control input-sm" style="min-width: 100%" />
                                        </div>
                                        <div class="form-group">
                                            <label for="description">ពណ៌នា</label>
                                            <input id="description" name="description" type="text" value="" class="form-control input-sm" placeholder="Description" />
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="hidden" id="wpid" />
                                        <span>ថ្លៃភ្លើង</span> : 1m<sup>3</sup> = <label id="wprice"></label><span> រៀល</span>
                                        <br />
                                        <span>ថ្លៃទឹក</span> : 1​KWH = <label id="pprice"></label><span> រៀល</span>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">

                <div class="col-md-3 col-md-offset-6" id="hidecheckout">
                    <button type="button" id="btnCheckOut" onclick="TestAction();" data-dismiss="modal" class="btn btn-danger btn-block btn-sm">Cancel</button>
                </div>
                <div class="col-md-3" id="hidepayment">
                    <button type="button" id="" onclick="OnPayAction()" class="btn btn-info btn-block btn-sm">Pay Now</button>
                </div>
            </div>
        </div>

    </div>
</div>
<script>

    function TestAction() {
        alert("Invoice id= " + $("#id").val());
    }



    function NewWaterRecordChange() {
        var waternewrecord = document.getElementById('newwaterrecord').value;
        var wateroldrecord = document.getElementById('oldwaterrecord').value;
        $.ajax({
            url: "/api/ExchangeRates/1/2",
            method: "GET",
            success: function (data) {
                var rate = data.rate;
                var totalwaterusage = ((parseFloat(waternewrecord) - parseFloat(wateroldrecord)) * parseFloat($('#wprice').text())) / rate;
                if (totalwaterusage <= 0) {
                    alert('Faild!');
                    $('#newwaterrecord').focus();
                } else {
                    $('#totalwater').val(totalwaterusage.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                    TotalPay();
                }
            },
            error: function (err) {
                toastr.error("no data record");
            }
        });
    }
    function NewPowerRecordChange() {
        var powernewrecord = document.getElementById('newpowerrecord').value;
        var powerroldrecord = document.getElementById('oldpowerrecord').value;

        $.ajax({
            url: "/api/ExchangeRates/1/2",
            method: "GET",
            success: function (data) {
                var rate = data.rate;
                var totalwaterusage = ((parseInt(powernewrecord) - parseInt(powerroldrecord)) * parseFloat($('#pprice').text())) / rate;
                if (totalwaterusage <= 0) {
                    alert('Faild!');
                    $('#newwaterrecord').focus();
                } else {
                    $('#totalpower').val(totalwaterusage.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
                    TotalPay();
                }
            },
            error: function (err) {
                toastr.error("no data record");
            }
        });

    }
    function TotalPay() {
        var totalwaterusage = document.getElementById('totalwater').value;
        var totalpowerusage = document.getElementById('totalpower').value;
        var roomprice = document.getElementById('roomprice').value;
        var servicecharge = document.getElementById('servicecharge').value;
        var grandtotal = parseFloat(totalwaterusage) + parseFloat(totalpowerusage) + parseFloat(roomprice) + parseFloat(servicecharge);
        $('#totalpay').val(grandtotal.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
        $('#totalpaykh').val((grandtotal * 4130).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));


    }


    function OnPayAction() {
        var data = new FormData();
        data.append("grandtotal", $("#totalpay").val());
        data.append("totalriel", $("#totalpaykh").val());
        data.append("totaldollar", $("#totalpay").val());
        data.append("totalother", $("#servicecharge").val());
        data.append("note", $("#note").val());
        data.append("payriel", $("#payriel").val());
        data.append("paydollar", $("#paydollar").val());
        data.append("paid", true);

        $.ajax({
            type: "PUT",
            url: "/api/invoices/" + $("#id").val(),
            contentType: false,
            processData: false,
            data: data,
            success: function (result) {
                UpdateWaterPayment();
                UpdatePowerPayment();
                toastr.success("Print Invoice successfully!.", "Server Response");
                window.location.reload(true);
            },
            error: function (errormesage) {
                toastr.error("Print invoice faild...!", "Server Respond");

            }
        });
    };

    function UpdateWaterPayment() {
        $.ajax({
            type: "PUT",
            url: "/api/updatewaters/" + $("#id").val() + "/" + $('#newpowerrecord').val(),
            contentType: false,
            processData: false,
            success: function (result) {
                //toastr.success("Update water payment has been Update successfully.", "Server Response");
            },
            error: function (error) {
                toastr.error("Update water payment status fail!", "Server Response");
            }
        });
    }

    function UpdatePowerPayment() {
        $.ajax({
            type: "PUT",
            url: "/api/updatepowers/" + $("#id").val() + "/" + $('#newpowerrecord').val(),
            contentType: false,
            processData: false,
            success: function (result) {
                //toastr.success("Room Status has been Update successfully.", "Server Response");
            },
            error: function (error) {
                toastr.error("Update room status fail!", "Server Response");
            }
        });
    }
    function OnClosePayment() {
        window.location.reload(true);
    }
</script>